<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>tri contour-d3</title>
  <Style>
      * {
  margin: 0;
  padding: 0;
}
#chart-container {
  position: relative;
  height: 100vh;
  overflow: hidden;
}
#contents { position: absolute;
   top: 0;
    bottom: 0;
     width: 100%;
}
#map { 
  position: absolute;
   top: 0;
    bottom: 0;
     width: 100%;
}
#contourCanvas { 
  position: absolute;
   top: 0;
    bottom: 0;
     width: 100%;
     height: 100%;
}
svg {
    position: absolute;
    width: 100%;
    height: 100%;
}

  </Style>

<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<meta property="og:title"              content="2022년 8월 8일 일강수량" />
<meta property="og:description"        content="" />
<meta property="og:image"              content="https://raw.githubusercontent.com/vuski/jsExer/main/rainFall/titleImage.jpg" />
<link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
<script type="text/javascript" src="./papaparse.min.js"></script>
<script src="./d3.v7.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/d3-tricontour@1"></script>
<script src='./mapbox-gl-language.js'></script>
<script src="./proj4-src.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>
<body>
  <div id = "contents" ></div>
  <div id = "map" ></div>



<script >

  const numberArray = range(20,400,2); 
  const basePoint = {x:953200, y:1947700};
  const [xcen,ycen] = proj4('EPSG:5179','EPSG:4326',[ basePoint.x, basePoint.y]);

  mapboxgl.accessToken = 'pk.eyJ1Ijoic2JraW00MjciLCJhIjoiY2o4b3Q0aXd1MDdyMjMzbnRxYTdvdDZrbCJ9.GCHi6-mDGEkd3F-knzSfRQ';
  const map = new mapboxgl.Map({
      container: 'map', // container ID
      //style: 'mapbox://styles/mapbox/streets-v11', // style URL
      style: 'mapbox://styles/sbkim427/cl6ool43r003o14kwmd8ogdwc',
      //style: 'mapbox://styles/mapbox/dark-v10',
      center: [xcen,ycen], // starting position [lng, lat]
      zoom: 10, // starting zoom
      //projection: 'globe' // display the map as a 3D globe
  });

  map.dragRotate.disable(); 
  map.touchZoomRotate.disableRotation();    
  map.addControl(new MapboxLanguage({
    defaultLanguage: 'ko'
  }));
      
  map.on('style.load', () => {
      map.setFog({}); // Set the default atmosphere style
  });

  function range(start, end, gap) {
        return Array((end - start)/gap + 1).fill().map((_, idx) => start + (idx*gap));
  }   

  let bound;
  (async function loadLocation() {
        
        await Papa.parse("./idxy.tsv", {
          download: true,
          header : true,
          delimiter :'\t',
          dynamicTyping : true,
          skipEmptyLines: true,
          complete: function(results) {           
            const xyTable = new Map();
            results.data.map((d) => {
              xyTable.set(d.id, [d.lon, d.lat]);
            });
            loadJson(xyTable);
          }         
        });
        
    })();



  async function loadJson(xyTable) {
        //let dataMove;
        await Papa.parse("./OBS_AWS_DD_20220811002900.csv", {
          download: true,
          header : true,
          delimiter :',',
          dynamicTyping : true,
          skipEmptyLines: true,
          complete: function(results) {
            //1. features로 변환
            const datenow = new Date('2022-08-08');
           
            const points = results.data.filter((d) => {
              const dateThis = new Date(d.date);
              let result = false;
              if (dateThis.getTime()== datenow.getTime()) result = true;
              if (d.id==376 || d.id==590 || d.id==425 || d.id==572) result = false; //이상지점 제거
              return result;
            }).map((d) => {
              const [x,y] = xyTable.get(d.id);
              return [x,y, d.rainfall]; 
            });

            const tri = d3.tricontour();
    
            //console.log("numberArray :"+numberArray);
            tri.thresholds(numberArray);
            const data = tri(points);

            functionDraw(data, points);
          }         
        });
        //return dataMove;
    };



function getScrollTop() {
	if( window.pageYOffset !== undefined ) {
		return window.pageYOffset;
	} else {
		return document.documentElement.scrollTop || document.body.scrollTop;
	}
}

function getScrollLeft() {
	if( window.pageXOffset !== undefined ) {
		return window.pageXOffset;
	} else {
		return document.documentElement.scrollLeft || document.body.scrollLeft;
	}
}

  function functionDraw(data, points) {
    //console.log("data:",data);  
   
    const smooth = ({type, value, coordinates}) => {
      //console.log(coordinates);
      return {type, value, coordinates: coordinates.map(rings => {        
          const smoothed = turf.polygonSmooth(turf.polygon(rings), {iterations: 2});
          //console.log(smoothed);
          return smoothed.features[0].geometry.coordinates;
        })
      };
    };

    const data2 = data.map(d => smooth(d));

    //console.log(contours);

    const w = window.innerWidth, h = document.documentElement.clientHeight;//window.innerHeight;

    function mapboxProjection() {
      
      return d3.geoTransform({
        point : function(x,y) {
          const p = map.project(new mapboxgl.LngLat(x, y));
          this.stream.point(p.x, p.y);
        }
      });
    }

    const container = map.getCanvasContainer();
    const mapColor = d3.scaleSequential(d3.interpolateCubehelixDefault).domain([400,0]);
    const w0 = window.innerWidth, h0 = window.innerHeight;

    const canvas = d3.select(container)
        .append("canvas")
        .attr("id", "contourCanvas")
        .attr("width", w0)
        .attr("height", h0);  

    const canvas0 = document.getElementById('contourCanvas');
    const context = canvas0.getContext("2d");
    
    const pathCanvas = d3.geoPath(mapboxProjection(),context) ;

    render();

    map.on("viewreset", render);
    map.on("move", render);
    map.on("moveend", render);    

    function render() {

      context.clearRect(0, 0, canvas0.width, canvas0.height);
      // context.globalAlpha = 0.2;
      // context.fillStyle = "#000000";
      // context.fillRect(0,0, canvas0.width, canvas0.height);
      // context.globalAlpha = 1.0;
      for (let i = 0; i<data2.length; i++) {
        const d = data2[i];
        const contourCollections = {
          type : "FeatureCollection",
          features : [{
            
              type : "Feature",
              properties : {
                value : d.value
              },
              geometry: {
                type : "MultiPolygon",
                coordinates : d.coordinates
              }          
          }]      
        };

        context.opacity = 0.7;
        context.lineWidth = d.value%100==0? 5 : d.value%10==0? 1 : 0.4;
        context.strokeStyle = mapColor(d.value);//%50==0? d.value : (Math.floor(d.value/50)+1)*50);

        context.beginPath();     
        pathCanvas(contourCollections);
        context.stroke();

      }

      context.textBaseline = 'middle';
      context.textAlign = 'center';
      for (let i=0 ; i<points.length ; i++) {
        const p = map.project(new mapboxgl.LngLat(points[i][0], points[i][1]));
        context.font = 'bold '+(parseInt(points[i][2]/15)+10) +'px Arial';
        context.fillStyle = mapColor(Math.round(points[i][2]));
        context.fillText(Math.round(points[i][2]), p.x, p.y);
        
      }

      context.font = 'bold 50px Arial';
      context.fillStyle = 'black';
      context.fillText("2022.08.08 일강수량", canvas0.width/2, 40);
      context.font = 'bold 20px Arial';
      context.fillText("수치가 표기된 곳이 기상 관측지점", canvas0.width/2, 75);

    }

        
    window.addEventListener('resize', function() {
      const w = window.innerWidth, h = window.innerHeight;

      d3.select("#contourCanvas")
          .attr("width", w)
          .attr("height", h);  
      render();
    });

  }




</script>
<script>


</script>

</body>
</html>